<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚µãƒƒã‚«ãƒ¼ãƒã‚¸ã‚·ãƒ§ãƒ³ãƒ—ãƒ­ãƒƒã‚¿ãƒ¼ Pro v6</title>
    <script src="https://Bernardo-Castilho.github.io/DragDropTouch/DragDropTouch.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --pitch-green: #4CAF50;
            --pitch-line: rgba(255, 255, 255, 0.8);
            --accent: #2196F3;
            --accent-dark: #1976D2;
            --danger: #FF5722;
            --text-main: #333;
        }
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            margin: 0; padding: 10px;
            background-color: #f0f2f5; color: var(--text-main);
            display: flex; flex-direction: column; height: 100vh; box-sizing: border-box;
        }
        h1 { margin: 5px 0 10px 0; font-size: 1.1rem; text-align: center; }

        .container { display: flex; gap: 15px; flex-grow: 1; overflow: hidden; }
        @media (max-width: 768px) {
            .container { flex-direction: column-reverse; height: auto; overflow: visible; }
            body { height: auto; overflow-y: auto; }
            .sidebar { max-height: none; }
        }

        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
        .sidebar {
            flex: 1; min-width: 250px;
            background: white; padding: 15px;
            border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex; flex-direction: column;
        }

        h3 { margin: 15px 0 8px 0; font-size: 0.95rem; border-bottom: 2px solid #eee; padding-bottom: 5px;}
        .form-group { margin-bottom: 10px; }
        label { display: block; margin-bottom: 4px; font-weight: bold; font-size: 0.85rem; color: #555;}
        input, select {
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px;
        }
        
        /* ãƒã‚¸ã‚·ãƒ§ãƒ³é¸æŠãƒœã‚¿ãƒ³ç¾¤ */
        .pos-selector { display: flex; gap: 5px; margin-bottom: 10px; }
        .pos-checkbox { display: none; }
        .pos-label {
            flex: 1; text-align: center; padding: 8px 2px;
            border: 1px solid #ddd; border-radius: 4px;
            font-size: 0.8rem; cursor: pointer; background: #f9f9f9; user-select: none;
        }
        .pos-checkbox:checked + .pos-label {
            background-color: var(--accent); color: white; border-color: var(--accent); font-weight: bold;
        }
        .pos-checkbox[value="GK"]:checked + .pos-label { background-color: #FFC107; color: black; border-color: #FFC107; }
        .pos-checkbox[value="DF"]:checked + .pos-label { background-color: #2196F3; }
        .pos-checkbox[value="MF"]:checked + .pos-label { background-color: #4CAF50; }
        .pos-checkbox[value="FW"]:checked + .pos-label { background-color: #E91E63; }

        button {
            width: 100%; padding: 12px; background-color: var(--accent); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;
        }
        button:hover { opacity: 0.9; }
        .btn-danger { background-color: var(--danger); margin-top: 20px; font-size: 0.8rem;}
        .btn-save-img { background-color: var(--pitch-green); margin-bottom: 10px; }
        .btn-edit { width: auto; padding: 4px 8px; font-size: 0.8rem; background: #ddd; color: #333; margin-left: auto; }

        /* é¸æ‰‹ãƒªã‚¹ãƒˆ */
        .player-list { margin-top: 10px; padding-bottom:10px; }
        .player-card {
            background: #fff; border: 1px solid #eee; padding: 8px 12px; margin-bottom: 6px; border-radius: 8px;
            cursor: grab; font-size: 0.9rem; display: flex; align-items: center; gap: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); touch-action: none;
        }
        .player-pos-badge { 
            background: #eee; font-size: 0.7rem; padding: 2px 5px; border-radius: 4px; font-weight: bold; color: #555;
        }

        /* ãƒ”ãƒƒãƒã‚¨ãƒªã‚¢ */
        .pitch-area {
            flex: 2; display: flex; justify-content: center; align-items: flex-start;
            background: #e0e0e0; border-radius: 12px; padding: 20px; overflow: auto; min-height: 300px; position: relative;
        }
        .pitch {
            width: 100%; max-width: 500px; aspect-ratio: 2/3;
            background-color: var(--pitch-green); position: relative;
            border: 3px solid var(--pitch-line); box-sizing: border-box;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            background-image: repeating-linear-gradient(0deg, transparent, transparent 20px, rgba(0,0,0,0.05) 20px, rgba(0,0,0,0.05) 40px);
        }
        /* ãƒ©ã‚¤ãƒ³ */
        .pitch::before { content: ''; position: absolute; top: 50%; left: 0; right: 0; height: 2px; background: var(--pitch-line); margin-top:-1px;}
        .pitch::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 20%; height: 13.3%; border: 2px solid var(--pitch-line); border-radius: 50%;}
        .penalty-area-top { position: absolute; top: 0; left: 25%; width: 50%; height: 16%; border: 2px solid var(--pitch-line); border-top: none;}
        .penalty-area-bottom { position: absolute; bottom: 0; left: 25%; width: 50%; height: 16%; border: 2px solid var(--pitch-line); border-bottom: none;}
        .goal-area-top { position: absolute; top: 0; left: 37.5%; width: 25%; height: 6%; border: 2px solid var(--pitch-line); border-top: none; opacity: 0.7;}
        .goal-area-bottom { position: absolute; bottom: 0; left: 37.5%; width: 25%; height: 6%; border: 2px solid var(--pitch-line); border-bottom: none; opacity: 0.7;}

        /* é¸æ‰‹ãƒ‰ãƒƒãƒˆ */
        .field-player {
            position: absolute; transform: translate(-50%, -50%);
            width: 44px; height: 44px;
            background: white; border: 2px solid #333; border-radius: 50%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            font-size: 0.75rem; font-weight: bold; color: #333;
            cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.3); z-index: 10;
            transition: transform 0.1s; touch-action: none;
        }
        .field-player:active { transform: translate(-50%, -50%) scale(0.9); }
        .field-player.drag-over { transform: translate(-50%, -50%) scale(1.1); filter: brightness(1.2); }
        .field-player .name-tooltip {
            position: absolute; bottom: -24px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white; padding: 3px 8px;
            border-radius: 10px; white-space: nowrap; font-size: 0.75rem; pointer-events: none;
        }

        .watermark { position: absolute; bottom: 5px; right: 10px; font-size: 0.7rem; color: #666; opacity: 0.5; pointer-events: none; }
        .current-formation-display { position: absolute; top: 5px; left: 10px; font-weight: bold; color: #333; background: rgba(255,255,255,0.7); padding: 2px 5px; border-radius: 4px; pointer-events: none;}

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«å…±é€š */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal {
            background: white; padding: 20px; border-radius: 12px; width: 90%; max-width: 400px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); max-height: 80vh; overflow-y: auto;
        }
        .modal h3 { margin-top: 0; text-align: center; }
        .modal-buttons { display: flex; gap: 10px; margin-top: 15px; }
        .btn-cancel { background-color: #999; }
        
        /* é¸æ‰‹é¸æŠãƒªã‚¹ãƒˆ (ãƒ¢ãƒ¼ãƒ€ãƒ«å†…) */
        .select-list { margin-top: 10px; }
        .select-item {
            padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center;
        }
        .select-item:hover { background-color: #f5f5f5; }

        /* ã‚«ã‚¹ã‚¿ãƒ è¨­å®šç”¨ */
        .custom-row {
            display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; padding: 5px 0; border-bottom: 1px solid #eee;
        }
        .custom-row label { margin: 0; flex: 1; }
        .custom-row input { width: 60px; text-align: center; }
        .counter-box { font-size: 0.9rem; text-align: right; color: #666; margin-bottom: 10px;}
        .counter-box span { font-weight: bold; color: var(--accent); }

    </style>
</head>
<body>

    <h1>ã‚µãƒƒã‚«ãƒ¼ãƒã‚¸ã‚·ãƒ§ãƒ³ãƒ—ãƒ­ãƒƒã‚¿ãƒ¼ Pro</h1>

    <div class="container">
        <div class="sidebar">
             <button class="btn-save-img" onclick="savePitchImage()">ğŸ“· é…ç½®ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>

            <h3>è¨­å®š</h3>
            <div style="display: flex; gap:10px;">
                <div style="flex:1">
                    <label>äººæ•°åˆ¶</label>
                    <select id="teamSizeSelector" onchange="handleSizeChange()">
                        <option value="8">8äººåˆ¶</option>
                        <option value="11" selected>11äººåˆ¶</option>
                        <option value="custom">ğŸ›  ã‚«ã‚¹ã‚¿ãƒ  (äººæ•°è‡ªç”±)</option>
                    </select>
                </div>
                <div style="flex:2">
                    <label>ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³</label>
                    <select id="formationSelector" onchange="handleFormationChange()">
                        </select>
                </div>
            </div>
            <small id="formationDesc" style="color: #666; font-size: 0.75rem; display:block; margin-top:5px; margin-bottom:10px;"></small>

            <h3>é¸æ‰‹ç™»éŒ²</h3>
            <div style="display: flex; gap: 5px; margin-bottom: 5px;">
                <input type="text" id="playerName" placeholder="åå‰" style="flex:2">
                <input type="text" id="playerNick" placeholder="è¡¨ç¤ºå" style="flex:1">
            </div>
            
            <label>ãƒã‚¸ã‚·ãƒ§ãƒ³ (è¤‡æ•°å¯)</label>
            <div class="pos-selector" id="regPosSelector">
                <input type="checkbox" id="posGK" value="GK" class="pos-checkbox"><label for="posGK" class="pos-label">GK</label>
                <input type="checkbox" id="posDF" value="DF" class="pos-checkbox"><label for="posDF" class="pos-label">DF</label>
                <input type="checkbox" id="posMF" value="MF" class="pos-checkbox" checked><label for="posMF" class="pos-label">MF</label>
                <input type="checkbox" id="posFW" value="FW" class="pos-checkbox"><label for="posFW" class="pos-label">FW</label>
            </div>

            <button onclick="addPlayer()">é¸æ‰‹ã‚’è¿½åŠ </button>

            <h3>ãƒ™ãƒ³ãƒ <small>(ã‚¿ãƒƒãƒ—ã§ç·¨é›† / ãƒ‰ãƒ©ãƒƒã‚°å¯)</small></h3>
            <div id="playerList" class="player-list" ondragover="allowDrop(event)" ondrop="dropToBench(event)" style="min-height: 80px; border: 2px dashed #ddd; border-radius: 8px; padding: 5px;"></div>
             
            <button class="btn-danger" onclick="clearAllData()">å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
        </div>

        <div class="pitch-area" id="captureArea">
            <div class="current-formation-display" id="onImageFormationName"></div>
            <div class="pitch" id="pitch">
                <div class="penalty-area-top"></div><div class="goal-area-top"></div>
                <div class="penalty-area-bottom"></div><div class="goal-area-bottom"></div>
                </div>
            <div class="watermark">Created with Position Plotter Pro</div>
        </div>
    </div>

    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <h3>é¸æ‰‹ç·¨é›†</h3>
            <div class="form-group">
                <label>åå‰</label>
                <input type="text" id="editName">
            </div>
            <div class="form-group">
                <label>è¡¨ç¤ºå</label>
                <input type="text" id="editNick">
            </div>
            <label>ãƒã‚¸ã‚·ãƒ§ãƒ³</label>
            <div class="pos-selector">
                <input type="checkbox" id="editPosGK" value="GK" class="pos-checkbox"><label for="editPosGK" class="pos-label">GK</label>
                <input type="checkbox" id="editPosDF" value="DF" class="pos-checkbox"><label for="editPosDF" class="pos-label">DF</label>
                <input type="checkbox" id="editPosMF" value="MF" class="pos-checkbox"><label for="editPosMF" class="pos-label">MF</label>
                <input type="checkbox" id="editPosFW" value="FW" class="pos-checkbox"><label for="editPosFW" class="pos-label">FW</label>
            </div>
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeEditModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button onclick="saveEditPlayer()">ä¿å­˜</button>
            </div>
            <div style="margin-top:15px; text-align:right;">
                <button onclick="deletePlayer()" style="background:none; border:none; color:red; width:auto; padding:0; cursor:pointer; font-size:0.8rem; text-decoration:underline;">ã“ã®é¸æ‰‹ã‚’å‰Šé™¤</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="assignModal">
        <div class="modal">
            <h3>é¸æ‰‹ã‚’é¸æŠ</h3>
            <p style="text-align:center; font-size:0.8rem; color:#666;">é…ç½®ã™ã‚‹é¸æ‰‹ã‚’é¸ã‚“ã§ãã ã•ã„</p>
            <div id="assignList" class="select-list"></div>
            <div class="modal-buttons" style="flex-direction: column;">
                <button class="btn-cancel" onclick="closeAssignModal()">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="customModal">
        <div class="modal">
            <h3>ã‚«ã‚¹ã‚¿ãƒ é…ç½®è¨­å®š</h3>
            <p style="text-align:center; font-size:0.85rem; color:#666; margin-bottom:15px;">äººæ•°ã‚’é¸æŠã—ã€å„ãƒã‚¸ã‚·ãƒ§ãƒ³ã«å‰²ã‚ŠæŒ¯ã£ã¦ãã ã•ã„ã€‚</p>

            <div class="form-group">
                <label>ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰äººæ•° (åˆè¨ˆ)</label>
                <select id="customTotal" onchange="updateCustomCounter()">
                    <option value="5">5äººåˆ¶</option>
                    <option value="6">6äººåˆ¶</option>
                    <option value="7">7äººåˆ¶</option>
                    <option value="8">8äººåˆ¶</option>
                    <option value="9">9äººåˆ¶</option>
                    <option value="10">10äººåˆ¶</option>
                    <option value="11" selected>11äººåˆ¶</option>
                </select>
            </div>

            <div class="custom-row">
                <label>GK (ã‚´ãƒ¼ãƒ«ã‚­ãƒ¼ãƒ‘ãƒ¼)</label>
                <input type="number" value="1" disabled style="background:#eee; font-weight:bold;">
            </div>
            <div class="custom-row">
                <label>DF (ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ãƒ€ãƒ¼)</label>
                <input type="number" id="customDF" value="4" min="0" max="5" onchange="updateCustomCounter()">
            </div>
            <div class="custom-row">
                <label>MF (ãƒŸãƒƒãƒ‰ãƒ•ã‚£ãƒ«ãƒ€ãƒ¼)</label>
                <input type="number" id="customMF" value="4" min="0" max="5" onchange="updateCustomCounter()">
            </div>
            <div class="custom-row">
                <label>FW (ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰)</label>
                <input type="number" id="customFW" value="2" min="0" max="5" onchange="updateCustomCounter()">
            </div>

            <div class="counter-box" id="customCounterDisplay">
                ç¾åœ¨: <span>11</span> / ç›®æ¨™: <span>11</span>
            </div>

            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeCustomModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button onclick="applyCustomFormation()">æ±ºå®šãƒ»ãƒ—ãƒ­ãƒƒãƒˆ</button>
            </div>
        </div>
    </div>

<script>
    // --- ãƒ‡ãƒ¼ã‚¿å®šç¾© ---
    const formations = {
        "8": {
            "2-3-2": { name: "2-3-2", desc: "JFAæ¨å¥¨ã€‚ãƒãƒ©ãƒ³ã‚¹å‹ã€‚", slots: [{x:50,y:90,r:"GK"},{x:30,y:75,r:"DF"},{x:70,y:75,r:"DF"},{x:20,y:50,r:"MF"},{x:50,y:50,r:"MF"},{x:80,y:50,r:"MF"},{x:35,y:25,r:"FW"},{x:65,y:25,r:"FW"}]},
            "3-3-1": { name: "3-3-1", desc: "å®‰å®šçš„ãƒ»ä¸€èˆ¬çš„ã€‚", slots: [{x:50,y:90,r:"GK"},{x:20,y:75,r:"DF"},{x:50,y:75,r:"DF"},{x:80,y:75,r:"DF"},{x:25,y:50,r:"MF"},{x:50,y:45,r:"MF"},{x:75,y:50,r:"MF"},{x:50,y:20,r:"FW"}]},
            "2-4-1": { name: "2-4-1", desc: "ä¸­ç›¤æ”¯é…å‹ã€‚", slots: [{x:50,y:90,r:"GK"},{x:35,y:80,r:"DF"},{x:65,y:80,r:"DF"},{x:15,y:50,r:"MF"},{x:40,y:55,r:"MF"},{x:60,y:55,r:"MF"},{x:85,y:50,r:"MF"},{x:50,y:20,r:"FW"}]},
            "3-2-2": { name: "3-2-2", desc: "å®ˆå‚™ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã€‚", slots: [{x:50,y:90,r:"GK"},{x:20,y:75,r:"DF"},{x:50,y:80,r:"DF"},{x:80,y:75,r:"DF"},{x:35,y:50,r:"MF"},{x:65,y:50,r:"MF"},{x:35,y:20,r:"FW"},{x:65,y:20,r:"FW"}]}
        },
        "11": {
            "4-4-2": { name: "4-4-2", desc: "ä¼çµ±çš„ãƒãƒ©ãƒ³ã‚¹å‹ã€‚", slots: [{x:50,y:92,r:"GK"},{x:15,y:78,r:"SB"},{x:38,y:82,r:"CB"},{x:62,y:82,r:"CB"},{x:85,y:78,r:"SB"},{x:15,y:45,r:"SH"},{x:38,y:52,r:"CH"},{x:62,y:52,r:"CH"},{x:85,y:45,r:"SH"},{x:35,y:20,r:"FW"},{x:65,y:20,r:"FW"}]},
            "4-3-3": { name: "4-3-3", desc: "ã‚µã‚¤ãƒ‰æ”»æ’ƒå‹ã€‚", slots: [{x:50,y:92,r:"GK"},{x:15,y:78,r:"SB"},{x:38,y:82,r:"CB"},{x:62,y:82,r:"CB"},{x:85,y:78,r:"SB"},{x:50,y:65,r:"DMF"},{x:30,y:45,r:"OMF"},{x:70,y:45,r:"OMF"},{x:15,y:25,r:"WG"},{x:50,y:18,r:"CF"},{x:85,y:25,r:"WG"}]},
            "4-2-3-1": { name: "4-2-3-1", desc: "èµ·ç‚¹ã‚’ä½œã‚‹ã€‚", slots: [{x:50,y:92,r:"GK"},{x:12,y:78,r:"SB"},{x:36,y:82,r:"CB"},{x:64,y:82,r:"CB"},{x:88,y:78,r:"SB"},{x:38,y:62,r:"DMF"},{x:62,y:62,r:"DMF"},{x:15,y:38,r:"SH"},{x:50,y:38,r:"OH"},{x:85,y:38,r:"SH"},{x:50,y:18,r:"CF"}]},
            "3-5-2": { name: "3-5-2", desc: "ä¸­ç›¤æ”¯é…ã€‚", slots: [{x:50,y:92,r:"GK"},{x:20,y:80,r:"CB"},{x:50,y:84,r:"CB"},{x:80,y:80,r:"CB"},{x:8,y:50,r:"WB"},{x:35,y:58,r:"DMF"},{x:65,y:58,r:"DMF"},{x:92,y:50,r:"WB"},{x:50,y:40,r:"OMF"},{x:35,y:20,r:"FW"},{x:65,y:20,r:"FW"}]},
            "3-4-3": { name: "3-4-3", desc: "æ”»æ’ƒçš„3ãƒãƒƒã‚¯ã€‚", slots: [{x:50,y:92,r:"GK"},{x:20,y:80,r:"CB"},{x:50,y:84,r:"CB"},{x:80,y:80,r:"CB"},{x:12,y:50,r:"WB"},{x:40,y:58,r:"CH"},{x:60,y:58,r:"CH"},{x:88,y:50,r:"WB"},{x:20,y:22,r:"WG"},{x:50,y:18,r:"CF"},{x:80,y:22,r:"WG"}]},
        }
    };

    let appState = {
        players: [],
        teamSize: "11",
        formationKey: "4-4-2",
        customConfig: null // ã‚«ã‚¹ã‚¿ãƒ è¨­å®šä¿æŒç”¨
    };
    const STORAGE_KEY = 'soccerPlotterData_v6';
    let editingPlayerId = null;
    let targetSlotIndex = null;
    let previousTeamSize = "11"; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã®å¾©å¸°ç”¨

    window.onload = function() {
        loadData();
        // åˆæœŸæç”»
        const sizeVal = appState.teamSize === 'custom' ? 'custom' : appState.teamSize;
        document.getElementById('teamSizeSelector').value = sizeVal;
        previousTeamSize = sizeVal;
        
        updateFormationOptions(false);
        renderApp();
    };

    function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(appState)); }
    function loadData() {
        const data = localStorage.getItem(STORAGE_KEY);
        if (data) {
            try {
                const parsed = JSON.parse(data);
                appState.teamSize = parsed.teamSize || "11";
                appState.formationKey = parsed.formationKey || "4-4-2";
                appState.customConfig = parsed.customConfig || null;
                appState.players = (parsed.players || []).map(p => {
                    if (typeof p.pos === 'string') return { ...p, pos: [p.pos] };
                    return p;
                });
            } catch (e) { console.error(e); }
        }
    }
    function clearAllData() {
        if(confirm("å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ")){
            localStorage.removeItem(STORAGE_KEY);
            location.reload();
        }
    }

    // --- è¨­å®šå¤‰æ›´ ---
    function handleSizeChange() {
        const val = document.getElementById('teamSizeSelector').value;
        if (val === 'custom') {
            openCustomModal();
        } else {
            previousTeamSize = val; // æ›´æ–°
            appState.teamSize = val;
            
            // ã‚µã‚¤ã‚ºå¤‰æ›´æ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é¸æŠ
            const options = formations[val];
            const firstKey = Object.keys(options)[0];
            appState.formationKey = firstKey;
            
            appState.customConfig = null; // ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã‚¯ãƒªã‚¢
            updateFormationOptions(true);
        }
    }
    
    function handleFormationChange() {
        const val = document.getElementById('formationSelector').value;
        appState.formationKey = val;
        renderApp(); 
        saveData();
    }

    function updateFormationOptions(shouldRender) {
        const selector = document.getElementById('formationSelector');
        selector.innerHTML = "";
        
        // ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆ
        if (appState.teamSize === 'custom' && appState.customConfig) {
            const {df, mf, fw} = appState.customConfig;
            const opt = document.createElement('option');
            opt.value = 'custom_result';
            opt.textContent = `ã‚«ã‚¹ã‚¿ãƒ  (${df}-${mf}-${fw})`;
            opt.selected = true;
            selector.appendChild(opt);
        } else {
            // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ (8 or 11)
            // ã‚‚ã—ä½•ã‚‰ã‹ã®ç†ç”±ã§customè¨­å®šãŒæ®‹ã£ã¦ã„ãŸã‚‰å®‰å…¨ç­–ã§11äººåˆ¶ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
            const size = (appState.teamSize === 'custom') ? "11" : appState.teamSize;
            const options = formations[size];
            
            let firstKey = null;
            for (const key in options) {
                if(!firstKey) firstKey = key;
                const opt = document.createElement('option');
                opt.value = key; opt.textContent = options[key].name;
                if(key === appState.formationKey) opt.selected = true;
                selector.appendChild(opt);
            }
            // é¸æŠä¸­ã®ã‚­ãƒ¼ãŒå­˜åœ¨ã—ãªã„å ´åˆï¼ˆã‚µã‚¤ã‚ºå¤‰æ›´ç›´å¾Œãªã©ï¼‰ã€å…ˆé ­ã‚’é¸æŠ
            if(!options[appState.formationKey]){
                appState.formationKey = firstKey;
                if(selector.options.length > 0) selector.options[0].selected = true;
            }
        }

        if(shouldRender) { 
            renderApp(); saveData(); 
        }
    }

    // --- ã‚«ã‚¹ã‚¿ãƒ è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« ---
    function openCustomModal() {
        // ç¾åœ¨ã®ã‚«ã‚¹ã‚¿ãƒ äººæ•°ã¾ãŸã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ(11)ã‚’ã‚»ãƒƒãƒˆ
        const initialTotal = (appState.teamSize === 'custom' && appState.customConfig) 
            ? (1 + appState.customConfig.df + appState.customConfig.mf + appState.customConfig.fw) 
            : 11;
            
        document.getElementById('customTotal').value = initialTotal;
        updateCustomCounter();
        document.getElementById('customModal').style.display = 'flex';
    }
    
    function closeCustomModal() {
        document.getElementById('customModal').style.display = 'none';
        
        // ã‚‚ã—ã€Œã‚«ã‚¹ã‚¿ãƒ ã€ã‚’é¸æŠã—ãŸãŒè¨­å®šã›ãšã«é–‰ã˜ãŸå ´åˆã€å‰ã®é¸æŠã«æˆ»ã™
        if (appState.teamSize !== 'custom' && document.getElementById('teamSizeSelector').value === 'custom') {
            document.getElementById('teamSizeSelector').value = previousTeamSize;
        }
    }

    function updateCustomCounter() {
        const total = parseInt(document.getElementById('customTotal').value);
        const df = parseInt(document.getElementById('customDF').value) || 0;
        const mf = parseInt(document.getElementById('customMF').value) || 0;
        const fw = parseInt(document.getElementById('customFW').value) || 0;
        const gk = 1;
        
        const currentTotal = gk + df + mf + fw;
        
        const display = document.getElementById('customCounterDisplay');
        display.innerHTML = `ç¾åœ¨: <span style="color:${currentTotal === total ? 'green' : 'red'}">${currentTotal}</span> / ç›®æ¨™: <span>${total}</span>`;
    }

    function applyCustomFormation() {
        const total = parseInt(document.getElementById('customTotal').value);
        const df = parseInt(document.getElementById('customDF').value) || 0;
        const mf = parseInt(document.getElementById('customMF').value) || 0;
        const fw = parseInt(document.getElementById('customFW').value) || 0;
        const gk = 1;

        if ((gk + df + mf + fw) !== total) {
            alert(`äººæ•°ã®åˆè¨ˆãŒåˆã„ã¾ã›ã‚“ã€‚\nç›®æ¨™: ${total}äºº\nç¾åœ¨: ${gk+df+mf+fw}äºº`);
            return;
        }

        // è¨­å®šä¿å­˜
        appState.teamSize = 'custom';
        appState.customConfig = { df, mf, fw };
        appState.formationKey = 'custom_result';
        
        // UIæ›´æ–°
        document.getElementById('teamSizeSelector').value = 'custom';
        previousTeamSize = 'custom';

        closeCustomModal();
        updateFormationOptions(true); // ã“ã‚ŒãŒãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤ºã‚’æ›´æ–°ã—ã€æç”»ã‚‚å‘¼ã¶
    }

    function generateCustomSlots(config) {
        const slots = [];
        // GK
        slots.push({x: 50, y: 92, r: "GK"});
        
        const addRow = (count, y, role) => {
            if (count <= 0) return;
            const step = 100 / (count + 1);
            for (let i = 1; i <= count; i++) {
                slots.push({x: step * i, y: y, r: role});
            }
        };

        addRow(config.df, 75, "DF");
        addRow(config.mf, 50, "MF");
        addRow(config.fw, 20, "FW");

        return slots;
    }


    // --- é¸æ‰‹æ“ä½œ ---
    function addPlayer() {
        const nameInput = document.getElementById('playerName');
        const nickInput = document.getElementById('playerNick');
        const positions = [];
        if(document.getElementById('posGK').checked) positions.push('GK');
        if(document.getElementById('posDF').checked) positions.push('DF');
        if(document.getElementById('posMF').checked) positions.push('MF');
        if(document.getElementById('posFW').checked) positions.push('FW');

        if (!nameInput.value) { alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
        if (positions.length === 0) { alert("ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }

        const player = {
            id: Date.now().toString(),
            name: nameInput.value,
            nick: nickInput.value || nameInput.value.slice(0, 2),
            pos: positions,
            slotIndex: null
        };
        appState.players.push(player);
        renderApp(); saveData();
        nameInput.value = ""; nickInput.value = "";
    }

    // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«
    function openEditModal(playerId) {
        const player = appState.players.find(p => p.id === playerId);
        if(!player) return;
        editingPlayerId = playerId;
        document.getElementById('editName').value = player.name;
        document.getElementById('editNick').value = player.nick;
        ['GK', 'DF', 'MF', 'FW'].forEach(pos => {
            document.getElementById('editPos' + pos).checked = player.pos.includes(pos);
        });
        document.getElementById('editModal').style.display = 'flex';
    }
    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
        editingPlayerId = null;
    }
    function saveEditPlayer() {
        if(!editingPlayerId) return;
        const player = appState.players.find(p => p.id === editingPlayerId);
        if(player) {
            const editedPos = [];
            ['GK', 'DF', 'MF', 'FW'].forEach(pos => {
                if(document.getElementById('editPos' + pos).checked) editedPos.push(pos);
            });
            if(editedPos.length === 0) { alert("ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
            player.name = document.getElementById('editName').value;
            player.nick = document.getElementById('editNick').value;
            player.pos = editedPos;
            renderApp(); saveData();
        }
        closeEditModal();
    }
    function deletePlayer() {
        if(!editingPlayerId) return;
        if(confirm("ã“ã®é¸æ‰‹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            appState.players = appState.players.filter(p => p.id !== editingPlayerId);
            renderApp(); saveData(); closeEditModal();
        }
    }

    // --- é…ç½®é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« ---
    function openAssignModal(slotIndex) {
        targetSlotIndex = slotIndex;
        const list = document.getElementById('assignList');
        list.innerHTML = "";

        const currentPlayer = appState.players.find(p => p.slotIndex === slotIndex);
        if (currentPlayer) {
            const div = document.createElement('div');
            div.className = 'select-item';
            div.style.background = '#ffebee';
            div.innerHTML = `<span><span style="font-weight:bold">${currentPlayer.name}</span> ã‚’å¤–ã™</span><span>âœ•</span>`;
            div.onclick = () => { assignPlayerToSlot(null); };
            list.appendChild(div);
        }

        const benchPlayers = appState.players.filter(p => p.slotIndex === null);
        if (benchPlayers.length === 0) {
            list.innerHTML += `<div style="padding:10px; color:#999; text-align:center;">ãƒ™ãƒ³ãƒã«é¸æ‰‹ãŒã„ã¾ã›ã‚“</div>`;
        }

        benchPlayers.forEach(p => {
            const div = document.createElement('div');
            div.className = 'select-item';
            div.innerHTML = `<span>${p.name} <small>(${p.pos.join('/')})</small></span><button class="btn-edit" style="margin:0">é¸æŠ</button>`;
            div.onclick = () => { assignPlayerToSlot(p.id); };
            list.appendChild(div);
        });

        document.getElementById('assignModal').style.display = 'flex';
    }

    function closeAssignModal() {
        document.getElementById('assignModal').style.display = 'none';
        targetSlotIndex = null;
    }

    function assignPlayerToSlot(playerId) {
        if (targetSlotIndex === null) return;
        const existing = appState.players.find(p => p.slotIndex === targetSlotIndex);
        if (existing) existing.slotIndex = null;
        if (playerId) {
            const player = appState.players.find(p => p.id === playerId);
            if (player) player.slotIndex = targetSlotIndex;
        }
        renderApp(); saveData(); closeAssignModal();
    }

    // --- æç”» ---
    function renderApp() {
        renderFormationSlots();
        renderPlayersOnField();
        renderPlayerList();
    }

    function renderPlayerList() {
        const list = document.getElementById('playerList');
        list.innerHTML = "";
        appState.players.forEach(p => {
            if (p.slotIndex === null) {
                const div = document.createElement('div');
                div.className = 'player-card';
                div.draggable = true;
                div.innerHTML = `
                    <div style="flex-grow:1; display:flex; align-items:center; gap:5px;">
                        <span style="font-weight:bold;">${p.name}</span>
                        <span class="player-pos-badge">${p.pos.join('/')}</span>
                    </div>
                    <button class="btn-edit" onclick="openEditModal('${p.id}')">âœï¸</button>
                `;
                div.ondragstart = (e) => dragStart(e, p.id);
                div.ontouchstart = (e) => dragStart(e, p.id);
                list.appendChild(div);
            }
        });
        if(list.children.length === 0) list.innerHTML = "<div style='color:#bbb; text-align:center; padding:10px; font-size:0.8rem;'>ãƒ™ãƒ³ãƒã¯ç©ºã§ã™</div>";
    }

    function renderFormationSlots() {
        const pitch = document.getElementById('pitch');
        let slots = [];
        let desc = "";
        let name = "";

        // ã‚«ã‚¹ã‚¿ãƒ ã‹é€šå¸¸ã‹ã§åˆ†å²
        if (appState.teamSize === 'custom' && appState.customConfig) {
            slots = generateCustomSlots(appState.customConfig);
            const {df, mf, fw} = appState.customConfig;
            const total = 1 + df + mf + fw;
            name = `ã‚«ã‚¹ã‚¿ãƒ  (${df}-${mf}-${fw})`;
            desc = `${total}äººåˆ¶ / GK:1 DF:${df} MF:${mf} FW:${fw}`;
        } else {
            // é€šå¸¸ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            // ãƒ‡ãƒ¼ã‚¿ä¸æ•´åˆé˜²æ­¢ã®å®‰å…¨ç­–
            const size = (appState.teamSize === 'custom') ? "11" : appState.teamSize; 
            const formList = formations[size] || formations["11"];
            const config = formList[appState.formationKey] || formList[Object.keys(formList)[0]];
            slots = config.slots;
            name = config.name;
            desc = config.desc;
        }

        document.getElementById('formationDesc').textContent = desc;
        document.getElementById('onImageFormationName').textContent = name;

        pitch.innerHTML = `
            <div class="penalty-area-top"></div><div class="goal-area-top"></div>
            <div class="penalty-area-bottom"></div><div class="goal-area-bottom"></div>
        `;
        
        // ã‚¹ãƒ­ãƒƒãƒˆæ•°ã‚ªãƒ¼ãƒãƒ¼ã®é¸æ‰‹ã‚’ãƒªã‚»ãƒƒãƒˆ
        appState.players.forEach(p => {
            if (p.slotIndex !== null && p.slotIndex >= slots.length) {
                p.slotIndex = null;
            }
        });

        slots.forEach((slot, index) => {
            const slotDiv = document.createElement('div');
            slotDiv.className = 'field-player';
            slotDiv.id = 'slot-' + index;
            slotDiv.style.left = slot.x + '%'; slotDiv.style.top = slot.y + '%';
            slotDiv.innerHTML = `<span style="opacity:0.3">${slot.r}</span>`;
            
            slotDiv.ondragover = allowDrop;
            slotDiv.ondragleave = dragLeave;
            slotDiv.ondrop = (e) => dropToField(e, index);
            slotDiv.onclick = (e) => { openAssignModal(index); };

            pitch.appendChild(slotDiv);
        });
    }

    function renderPlayersOnField() {
        appState.players.forEach(p => {
            if (p.slotIndex !== null) {
                const slotDiv = document.getElementById('slot-' + p.slotIndex);
                if (slotDiv) {
                    const mainPos = p.pos[0];
                    const bgColor = mainPos === 'GK' ? '#FFC107' : (mainPos === 'DF' ? '#2196F3' : (mainPos === 'MF' ? '#4CAF50' : '#E91E63'));
                    const textColor = mainPos === 'GK' ? '#000' : '#FFF';
                    slotDiv.style.background = bgColor; 
                    slotDiv.style.color = textColor;
                    slotDiv.style.border = "2px solid white";
                    slotDiv.innerHTML = `${p.nick}<div class="name-tooltip">${p.name}</div>`;
                    slotDiv.draggable = true;
                    slotDiv.ondragstart = (evt) => dragStart(evt, p.id);
                    slotDiv.ontouchstart = (evt) => dragStart(evt, p.id);
                    slotDiv.onclick = (e) => { e.stopPropagation(); openAssignModal(p.slotIndex); };
                } else {
                    p.slotIndex = null;
                }
            }
        });
    }

    // --- ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ— ---
    function dragStart(e, playerId) { e.dataTransfer.effectAllowed = "move"; e.dataTransfer.setData("text/plain", playerId); }
    function allowDrop(e) { e.preventDefault(); if(e.target.classList.contains('field-player')){ e.target.classList.add('drag-over'); } }
    function dragLeave(e) { if(e.target.classList.contains('field-player')){ e.target.classList.remove('drag-over'); } }
    function dropToField(e, slotIndex) {
        e.preventDefault(); e.stopPropagation();
        e.target.classList.remove('drag-over');
        const playerId = e.dataTransfer.getData("text/plain");
        const player = appState.players.find(p => p.id === playerId);
        if (!player) return;
        const existingPlayer = appState.players.find(p => p.slotIndex === slotIndex && p.id !== playerId);
        if (existingPlayer) existingPlayer.slotIndex = null;
        player.slotIndex = slotIndex;
        renderApp(); saveData();
    }
    function dropToBench(e) {
        e.preventDefault();
        const playerId = e.dataTransfer.getData("text/plain");
        const player = appState.players.find(p => p.id === playerId);
        if (player && player.slotIndex !== null) {
            player.slotIndex = null;
            renderApp(); saveData();
        }
    }

    // --- ç”»åƒä¿å­˜ ---
    function savePitchImage() {
        const captureArea = document.getElementById('captureArea');
        const btn = document.querySelector('.btn-save-img');
        const originalText = btn.textContent;
        btn.disabled = true; btn.textContent = "ç”Ÿæˆä¸­...";
        html2canvas(captureArea, { scale: 2, backgroundColor: "#e0e0e0", logging: false, useCORS: true }).then(canvas => {
            const link = document.createElement('a');
            link.download = `formation_${new Date().getTime()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            btn.disabled = false; btn.textContent = originalText;
        }).catch(err => { console.error(err); alert("ä¿å­˜ã‚¨ãƒ©ãƒ¼"); btn.disabled = false; btn.textContent = originalText; });
    }
</script>
</body>
</html>
