<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„Çµ„ÉÉ„Ç´„Éº„Éù„Ç∏„Ç∑„Éß„É≥„Éó„É≠„ÉÉ„Çø„Éº Pro v4</title>
    <script src="https://Bernardo-Castilho.github.io/DragDropTouch/DragDropTouch.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --pitch-green: #4CAF50;
            --pitch-line: rgba(255, 255, 255, 0.8);
            --accent: #2196F3;
            --accent-dark: #1976D2;
            --danger: #FF5722;
            --text-main: #333;
        }
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            margin: 0; padding: 10px;
            background-color: #f0f2f5; color: var(--text-main);
            display: flex; flex-direction: column; height: 100vh; box-sizing: border-box;
        }
        h1 { margin: 5px 0 10px 0; font-size: 1.1rem; text-align: center; }

        .container { display: flex; gap: 15px; flex-grow: 1; overflow: hidden; }
        @media (max-width: 768px) {
            .container { flex-direction: column-reverse; height: auto; overflow: visible; }
            body { height: auto; overflow-y: auto; }
            .sidebar { max-height: none; }
        }

        /* „Çµ„Ç§„Éâ„Éê„Éº */
        .sidebar {
            flex: 1; min-width: 250px;
            background: white; padding: 15px;
            border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex; flex-direction: column;
        }

        h3 { margin: 15px 0 8px 0; font-size: 0.95rem; border-bottom: 2px solid #eee; padding-bottom: 5px;}
        .form-group { margin-bottom: 10px; }
        label { display: block; margin-bottom: 4px; font-weight: bold; font-size: 0.85rem; color: #555;}
        input, select {
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px;
        }
        
        /* „Éù„Ç∏„Ç∑„Éß„É≥ÈÅ∏Êäû„Éú„Çø„É≥Áæ§ */
        .pos-selector { display: flex; gap: 5px; margin-bottom: 10px; }
        .pos-checkbox { display: none; }
        .pos-label {
            flex: 1; text-align: center; padding: 8px 2px;
            border: 1px solid #ddd; border-radius: 4px;
            font-size: 0.8rem; cursor: pointer; background: #f9f9f9; user-select: none;
        }
        .pos-checkbox:checked + .pos-label {
            background-color: var(--accent); color: white; border-color: var(--accent); font-weight: bold;
        }
        .pos-checkbox[value="GK"]:checked + .pos-label { background-color: #FFC107; color: black; border-color: #FFC107; }
        .pos-checkbox[value="DF"]:checked + .pos-label { background-color: #2196F3; }
        .pos-checkbox[value="MF"]:checked + .pos-label { background-color: #4CAF50; }
        .pos-checkbox[value="FW"]:checked + .pos-label { background-color: #E91E63; }

        button {
            width: 100%; padding: 12px; background-color: var(--accent); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;
        }
        button:hover { opacity: 0.9; }
        .btn-danger { background-color: var(--danger); margin-top: 20px; font-size: 0.8rem;}
        .btn-save-img { background-color: var(--pitch-green); margin-bottom: 10px; }
        .btn-edit { width: auto; padding: 4px 8px; font-size: 0.8rem; background: #ddd; color: #333; margin-left: auto; }

        /* ÈÅ∏Êâã„É™„Çπ„Éà */
        .player-list { margin-top: 10px; padding-bottom:10px; }
        .player-card {
            background: #fff; border: 1px solid #eee; padding: 8px 12px; margin-bottom: 6px; border-radius: 8px;
            cursor: grab; font-size: 0.9rem; display: flex; align-items: center; gap: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); touch-action: none;
        }
        .player-pos-badge { 
            background: #eee; font-size: 0.7rem; padding: 2px 5px; border-radius: 4px; font-weight: bold; color: #555;
        }

        /* „Éî„ÉÉ„ÉÅ„Ç®„É™„Ç¢ */
        .pitch-area {
            flex: 2; display: flex; justify-content: center; align-items: flex-start;
            background: #e0e0e0; border-radius: 12px; padding: 20px; overflow: auto; min-height: 300px; position: relative;
        }
        .pitch {
            width: 100%; max-width: 500px; aspect-ratio: 2/3;
            background-color: var(--pitch-green); position: relative;
            border: 3px solid var(--pitch-line); box-sizing: border-box;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            background-image: repeating-linear-gradient(0deg, transparent, transparent 20px, rgba(0,0,0,0.05) 20px, rgba(0,0,0,0.05) 40px);
        }
        /* „É©„Ç§„É≥ */
        .pitch::before { content: ''; position: absolute; top: 50%; left: 0; right: 0; height: 2px; background: var(--pitch-line); margin-top:-1px;}
        .pitch::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 20%; height: 13.3%; border: 2px solid var(--pitch-line); border-radius: 50%;}
        .penalty-area-top { position: absolute; top: 0; left: 25%; width: 50%; height: 16%; border: 2px solid var(--pitch-line); border-top: none;}
        .penalty-area-bottom { position: absolute; bottom: 0; left: 25%; width: 50%; height: 16%; border: 2px solid var(--pitch-line); border-bottom: none;}
        .goal-area-top { position: absolute; top: 0; left: 37.5%; width: 25%; height: 6%; border: 2px solid var(--pitch-line); border-top: none; opacity: 0.7;}
        .goal-area-bottom { position: absolute; bottom: 0; left: 37.5%; width: 25%; height: 6%; border: 2px solid var(--pitch-line); border-bottom: none; opacity: 0.7;}

        /* ÈÅ∏Êâã„Éâ„ÉÉ„Éà */
        .field-player {
            position: absolute; transform: translate(-50%, -50%);
            width: 44px; height: 44px;
            background: white; border: 2px solid #333; border-radius: 50%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            font-size: 0.75rem; font-weight: bold; color: #333;
            cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.3); z-index: 10;
            transition: transform 0.1s; touch-action: none;
        }
        .field-player:active { transform: translate(-50%, -50%) scale(0.9); }
        .field-player.drag-over { transform: translate(-50%, -50%) scale(1.1); filter: brightness(1.2); }
        .field-player .name-tooltip {
            position: absolute; bottom: -24px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white; padding: 3px 8px;
            border-radius: 10px; white-space: nowrap; font-size: 0.75rem; pointer-events: none;
        }

        .watermark { position: absolute; bottom: 5px; right: 10px; font-size: 0.7rem; color: #666; opacity: 0.5; pointer-events: none; }
        .current-formation-display { position: absolute; top: 5px; left: 10px; font-weight: bold; color: #333; background: rgba(255,255,255,0.7); padding: 2px 5px; border-radius: 4px; pointer-events: none;}

        /* „É¢„Éº„ÉÄ„É´ÂÖ±ÈÄö */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal {
            background: white; padding: 20px; border-radius: 12px; width: 90%; max-width: 400px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); max-height: 80vh; overflow-y: auto;
        }
        .modal h3 { margin-top: 0; text-align: center; }
        .modal-buttons { display: flex; gap: 10px; margin-top: 15px; }
        .btn-cancel { background-color: #999; }
        
        /* ÈÅ∏ÊâãÈÅ∏Êäû„É™„Çπ„Éà („É¢„Éº„ÉÄ„É´ÂÜÖ) */
        .select-list { margin-top: 10px; }
        .select-item {
            padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center;
        }
        .select-item:hover { background-color: #f5f5f5; }
        .select-item.selected { background-color: #e3f2fd; }

    </style>
</head>
<body>

    <h1>„Çµ„ÉÉ„Ç´„Éº„Éù„Ç∏„Ç∑„Éß„É≥„Éó„É≠„ÉÉ„Çø„Éº Pro</h1>

    <div class="container">
        <div class="sidebar">
             <button class="btn-save-img" onclick="savePitchImage()">üì∑ ÈÖçÁΩÆÁîªÂÉè„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</button>

            <h3>Ë®≠ÂÆö</h3>
            <div style="display: flex; gap:10px;">
                <div style="flex:1">
                    <label>‰∫∫Êï∞</label>
                    <select id="teamSizeSelector" onchange="handleSizeChange()">
                        <option value="8">8‰∫∫Âà∂</option>
                        <option value="11" selected>11‰∫∫Âà∂</option>
                    </select>
                </div>
                <div style="flex:2">
                    <label>„Éï„Ç©„Éº„É°„Éº„Ç∑„Éß„É≥</label>
                    <select id="formationSelector" onchange="handleFormationChange()"></select>
                </div>
            </div>
            <small id="formationDesc" style="color: #666; font-size: 0.75rem; display:block; margin-top:5px; margin-bottom:10px;"></small>

            <h3>ÈÅ∏ÊâãÁôªÈå≤</h3>
            <div style="display: flex; gap: 5px; margin-bottom: 5px;">
                <input type="text" id="playerName" placeholder="ÂêçÂâç" style="flex:2">
                <input type="text" id="playerNick" placeholder="Ë°®Á§∫Âêç" style="flex:1">
            </div>
            
            <label>„Éù„Ç∏„Ç∑„Éß„É≥ (Ë§áÊï∞ÂèØ)</label>
            <div class="pos-selector" id="regPosSelector">
                <input type="checkbox" id="posGK" value="GK" class="pos-checkbox"><label for="posGK" class="pos-label">GK</label>
                <input type="checkbox" id="posDF" value="DF" class="pos-checkbox"><label for="posDF" class="pos-label">DF</label>
                <input type="checkbox" id="posMF" value="MF" class="pos-checkbox" checked><label for="posMF" class="pos-label">MF</label>
                <input type="checkbox" id="posFW" value="FW" class="pos-checkbox"><label for="posFW" class="pos-label">FW</label>
            </div>

            <button onclick="addPlayer()">ÈÅ∏Êâã„ÇíËøΩÂä†</button>

            <h3>„Éô„É≥„ÉÅ <small>(„Çø„ÉÉ„Éó„ÅßÁ∑®ÈõÜ / „Éâ„É©„ÉÉ„Ç∞ÂèØ)</small></h3>
            <div id="playerList" class="player-list" ondragover="allowDrop(event)" ondrop="dropToBench(event)" style="min-height: 80px; border: 2px dashed #ddd; border-radius: 8px; padding: 5px;"></div>
             
            <button class="btn-danger" onclick="clearAllData()">ÂÖ®„Éá„Éº„Çø„Çí„É™„Çª„ÉÉ„Éà</button>
        </div>

        <div class="pitch-area" id="captureArea">
            <div class="current-formation-display" id="onImageFormationName"></div>
            <div class="pitch" id="pitch">
                <div class="penalty-area-top"></div><div class="goal-area-top"></div>
                <div class="penalty-area-bottom"></div><div class="goal-area-bottom"></div>
                </div>
            <div class="watermark">Created with Position Plotter Pro</div>
        </div>
    </div>

    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <h3>ÈÅ∏ÊâãÁ∑®ÈõÜ</h3>
            <div class="form-group">
                <label>ÂêçÂâç</label>
                <input type="text" id="editName">
            </div>
            <div class="form-group">
                <label>Ë°®Á§∫Âêç</label>
                <input type="text" id="editNick">
            </div>
            <label>„Éù„Ç∏„Ç∑„Éß„É≥</label>
            <div class="pos-selector">
                <input type="checkbox" id="editPosGK" value="GK" class="pos-checkbox"><label for="editPosGK" class="pos-label">GK</label>
                <input type="checkbox" id="editPosDF" value="DF" class="pos-checkbox"><label for="editPosDF" class="pos-label">DF</label>
                <input type="checkbox" id="editPosMF" value="MF" class="pos-checkbox"><label for="editPosMF" class="pos-label">MF</label>
                <input type="checkbox" id="editPosFW" value="FW" class="pos-checkbox"><label for="editPosFW" class="pos-label">FW</label>
            </div>
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeEditModal()">„Ç≠„É£„É≥„Çª„É´</button>
                <button onclick="saveEditPlayer()">‰øùÂ≠ò</button>
            </div>
            <div style="margin-top:15px; text-align:right;">
                <button onclick="deletePlayer()" style="background:none; border:none; color:red; width:auto; padding:0; cursor:pointer; font-size:0.8rem; text-decoration:underline;">„Åì„ÅÆÈÅ∏Êâã„ÇíÂâäÈô§</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="assignModal">
        <div class="modal">
            <h3>ÈÅ∏Êâã„ÇíÈÅ∏Êäû</h3>
            <p style="text-align:center; font-size:0.8rem; color:#666;">ÈÖçÁΩÆ„Åô„ÇãÈÅ∏Êâã„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ</p>
            
            <div id="assignList" class="select-list">
                </div>

            <div class="modal-buttons" style="flex-direction: column;">
                <button class="btn-cancel" onclick="closeAssignModal()">Èñâ„Åò„Çã</button>
            </div>
        </div>
    </div>

<script>
    // --- „Éá„Éº„ÇøÂÆöÁæ© ---
    const formations = {
        "8": {
            "2-3-2": { name: "2-3-2", desc: "JFAÊé®Â•®„ÄÇ„Éê„É©„É≥„ÇπÂûã„ÄÇ", slots: [{x:50,y:90,r:"GK"},{x:30,y:75,r:"DF"},{x:70,y:75,r:"DF"},{x:20,y:50,r:"MF"},{x:50,y:50,r:"MF"},{x:80,y:50,r:"MF"},{x:35,y:25,r:"FW"},{x:65,y:25,r:"FW"}]},
            "3-3-1": { name: "3-3-1", desc: "ÂÆâÂÆöÁöÑ„Éª‰∏ÄËà¨ÁöÑ„ÄÇ", slots: [{x:50,y:90,r:"GK"},{x:20,y:75,r:"DF"},{x:50,y:75,r:"DF"},{x:80,y:75,r:"DF"},{x:25,y:50,r:"MF"},{x:50,y:45,r:"MF"},{x:75,y:50,r:"MF"},{x:50,y:20,r:"FW"}]},
            "2-4-1": { name: "2-4-1", desc: "‰∏≠Áõ§ÊîØÈÖçÂûã„ÄÇ", slots: [{x:50,y:90,r:"GK"},{x:35,y:80,r:"DF"},{x:65,y:80,r:"DF"},{x:15,y:50,r:"MF"},{x:40,y:55,r:"MF"},{x:60,y:55,r:"MF"},{x:85,y:50,r:"MF"},{x:50,y:20,r:"FW"}]},
            "3-2-2": { name: "3-2-2", desc: "ÂÆàÂÇô„Ç´„Ç¶„É≥„Çø„Éº„ÄÇ", slots: [{x:50,y:90,r:"GK"},{x:20,y:75,r:"DF"},{x:50,y:80,r:"DF"},{x:80,y:75,r:"DF"},{x:35,y:50,r:"MF"},{x:65,y:50,r:"MF"},{x:35,y:20,r:"FW"},{x:65,y:20,r:"FW"}]}
        },
        "11": {
            "4-4-2": { name: "4-4-2", desc: "‰ºùÁµ±ÁöÑ„Éê„É©„É≥„ÇπÂûã„ÄÇ", slots: [{x:50,y:92,r:"GK"},{x:15,y:78,r:"SB"},{x:38,y:82,r:"CB"},{x:62,y:82,r:"CB"},{x:85,y:78,r:"SB"},{x:15,y:45,r:"SH"},{x:38,y:52,r:"CH"},{x:62,y:52,r:"CH"},{x:85,y:45,r:"SH"},{x:35,y:20,r:"FW"},{x:65,y:20,r:"FW"}]},
            "4-3-3": { name: "4-3-3", desc: "„Çµ„Ç§„ÉâÊîªÊíÉÂûã„ÄÇ", slots: [{x:50,y:92,r:"GK"},{x:15,y:78,r:"SB"},{x:38,y:82,r:"CB"},{x:62,y:82,r:"CB"},{x:85,y:78,r:"SB"},{x:50,y:65,r:"DMF"},{x:30,y:45,r:"OMF"},{x:70,y:45,r:"OMF"},{x:15,y:25,r:"WG"},{x:50,y:18,r:"CF"},{x:85,y:25,r:"WG"}]},
            "4-2-3-1": { name: "4-2-3-1", desc: "Ëµ∑ÁÇπ„Çí‰Ωú„Çã„ÄÇ", slots: [{x:50,y:92,r:"GK"},{x:12,y:78,r:"SB"},{x:36,y:82,r:"CB"},{x:64,y:82,r:"CB"},{x:88,y:78,r:"SB"},{x:38,y:62,r:"DMF"},{x:62,y:62,r:"DMF"},{x:15,y:38,r:"SH"},{x:50,y:38,r:"OH"},{x:85,y:38,r:"SH"},{x:50,y:18,r:"CF"}]},
            "3-5-2": { name: "3-5-2", desc: "‰∏≠Áõ§ÊîØÈÖç„ÄÇ", slots: [{x:50,y:92,r:"GK"},{x:20,y:80,r:"CB"},{x:50,y:84,r:"CB"},{x:80,y:80,r:"CB"},{x:8,y:50,r:"WB"},{x:35,y:58,r:"DMF"},{x:65,y:58,r:"DMF"},{x:92,y:50,r:"WB"},{x:50,y:40,r:"OMF"},{x:35,y:20,r:"FW"},{x:65,y:20,r:"FW"}]},
            "3-4-3": { name: "3-4-3", desc: "ÊîªÊíÉÁöÑ3„Éê„ÉÉ„ÇØ„ÄÇ", slots: [{x:50,y:92,r:"GK"},{x:20,y:80,r:"CB"},{x:50,y:84,r:"CB"},{x:80,y:80,r:"CB"},{x:12,y:50,r:"WB"},{x:40,y:58,r:"CH"},{x:60,y:58,r:"CH"},{x:88,y:50,r:"WB"},{x:20,y:22,r:"WG"},{x:50,y:18,r:"CF"},{x:80,y:22,r:"WG"}]},
            "4-1-4-1": { name: "4-1-4-1", desc: "„Ç¢„É≥„Ç´„ÉºÈÖçÁΩÆ„ÄÇ", slots: [{x:50,y:92,r:"GK"},{x:10,y:75,r:"SB"},{x:35,y:80,r:"CB"},{x:65,y:80,r:"CB"},{x:90,y:75,r:"SB"},{x:50,y:65,r:"DMF"},{x:15,y:40,r:"SH"},{x:35,y:45,r:"IH"},{x:65,y:45,r:"IH"},{x:85,y:40,r:"SH"},{x:50,y:15,r:"CF"}]}
        }
    };

    let appState = {
        players: [],
        teamSize: "11",
        formationKey: "4-4-2"
    };
    const STORAGE_KEY = 'soccerPlotterData_v2';
    let editingPlayerId = null;
    let targetSlotIndex = null; // „Çø„ÉÉ„ÉóÈÖçÁΩÆÁî®

    window.onload = function() {
        loadData();
        updateFormationOptions(false);
        renderApp();
    };

    function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(appState)); }
    function loadData() {
        const data = localStorage.getItem(STORAGE_KEY);
        if (data) {
            try {
                const parsed = JSON.parse(data);
                appState.teamSize = parsed.teamSize || "11";
                appState.formationKey = parsed.formationKey || "4-4-2";
                appState.players = (parsed.players || []).map(p => {
                    if (typeof p.pos === 'string') return { ...p, pos: [p.pos] };
                    return p;
                });
                document.getElementById('teamSizeSelector').value = appState.teamSize;
            } catch (e) { console.error(e); }
        }
    }
    function clearAllData() {
        if(confirm("ÂÖ®„Å¶„ÅÆ„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Å¶ÂàùÊúüÂåñ„Åó„Åæ„Åô„ÅãÔºü")){
            localStorage.removeItem(STORAGE_KEY);
            location.reload();
        }
    }

    // --- Ë®≠ÂÆöÂ§âÊõ¥ ---
    function handleSizeChange() {
        appState.teamSize = document.getElementById('teamSizeSelector').value;
        updateFormationOptions(true);
    }
    function handleFormationChange() {
        appState.formationKey = document.getElementById('formationSelector').value;
        renderApp(); saveData();
    }
    function updateFormationOptions(shouldRender) {
        const size = appState.teamSize;
        const selector = document.getElementById('formationSelector');
        selector.innerHTML = "";
        const options = formations[size];
        let firstKey = null;
        for (const key in options) {
            if(!firstKey) firstKey = key;
            const opt = document.createElement('option');
            opt.value = key; opt.textContent = options[key].name;
            if(key === appState.formationKey) opt.selected = true;
            selector.appendChild(opt);
        }
        if(!options[appState.formationKey]){
            appState.formationKey = firstKey;
             if(selector.options.length > 0) selector.options[0].selected = true;
        }
        if(shouldRender) { renderApp(); saveData(); }
    }

    // --- ÈÅ∏ÊâãÊìç‰Ωú ---
    function addPlayer() {
        const nameInput = document.getElementById('playerName');
        const nickInput = document.getElementById('playerNick');
        const positions = [];
        if(document.getElementById('posGK').checked) positions.push('GK');
        if(document.getElementById('posDF').checked) positions.push('DF');
        if(document.getElementById('posMF').checked) positions.push('MF');
        if(document.getElementById('posFW').checked) positions.push('FW');

        if (!nameInput.value) { alert("ÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ"); return; }
        if (positions.length === 0) { alert("„Éù„Ç∏„Ç∑„Éß„É≥„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ"); return; }

        const player = {
            id: Date.now().toString(),
            name: nameInput.value,
            nick: nickInput.value || nameInput.value.slice(0, 2),
            pos: positions,
            slotIndex: null
        };
        appState.players.push(player);
        renderApp(); saveData();
        nameInput.value = ""; nickInput.value = "";
    }

    // Á∑®ÈõÜ„É¢„Éº„ÉÄ„É´
    function openEditModal(playerId) {
        const player = appState.players.find(p => p.id === playerId);
        if(!player) return;
        editingPlayerId = playerId;
        document.getElementById('editName').value = player.name;
        document.getElementById('editNick').value = player.nick;
        ['GK', 'DF', 'MF', 'FW'].forEach(pos => {
            document.getElementById('editPos' + pos).checked = player.pos.includes(pos);
        });
        document.getElementById('editModal').style.display = 'flex';
    }
    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
        editingPlayerId = null;
    }
    function saveEditPlayer() {
        if(!editingPlayerId) return;
        const player = appState.players.find(p => p.id === editingPlayerId);
        if(player) {
            const editedPos = [];
            ['GK', 'DF', 'MF', 'FW'].forEach(pos => {
                if(document.getElementById('editPos' + pos).checked) editedPos.push(pos);
            });
            if(editedPos.length === 0) { alert("„Éù„Ç∏„Ç∑„Éß„É≥„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ"); return; }
            player.name = document.getElementById('editName').value;
            player.nick = document.getElementById('editNick').value;
            player.pos = editedPos;
            renderApp(); saveData();
        }
        closeEditModal();
    }
    function deletePlayer() {
        if(!editingPlayerId) return;
        if(confirm("„Åì„ÅÆÈÅ∏Êâã„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")) {
            appState.players = appState.players.filter(p => p.id !== editingPlayerId);
            renderApp(); saveData(); closeEditModal();
        }
    }

    // --- ÈÖçÁΩÆÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ÔºàÊñ∞Ê©üËÉΩÔºâ ---
    function openAssignModal(slotIndex) {
        targetSlotIndex = slotIndex;
        const list = document.getElementById('assignList');
        list.innerHTML = "";

        // „Åì„ÅÆ„Çπ„É≠„ÉÉ„Éà„Å´ÁèæÂú®ÈÖçÁΩÆ„Åï„Çå„Å¶„ÅÑ„ÇãÈÅ∏Êâã
        const currentPlayer = appState.players.find(p => p.slotIndex === slotIndex);
        if (currentPlayer) {
            const div = document.createElement('div');
            div.className = 'select-item';
            div.style.background = '#ffebee';
            div.innerHTML = `
                <span><span style="font-weight:bold">${currentPlayer.name}</span> „ÇíÂ§ñ„Åô</span>
                <span style="font-size:0.8rem">‚úï</span>
            `;
            div.onclick = () => { assignPlayerToSlot(null); }; // null„ÅßÂ§ñ„Åô
            list.appendChild(div);
        }

        // „Éô„É≥„ÉÅ„ÅÆÈÅ∏Êâã‰∏ÄË¶ß
        const benchPlayers = appState.players.filter(p => p.slotIndex === null);
        if (benchPlayers.length === 0) {
            list.innerHTML += `<div style="padding:10px; color:#999; text-align:center;">„Éô„É≥„ÉÅ„Å´ÈÅ∏Êâã„Åå„ÅÑ„Åæ„Åõ„Çì</div>`;
        }

        benchPlayers.forEach(p => {
            const div = document.createElement('div');
            div.className = 'select-item';
            div.innerHTML = `
                <span>${p.name} <small>(${p.pos.join('/')})</small></span>
                <button class="btn-edit" style="margin:0">ÈÅ∏Êäû</button>
            `;
            div.onclick = () => { assignPlayerToSlot(p.id); };
            list.appendChild(div);
        });

        document.getElementById('assignModal').style.display = 'flex';
    }

    function closeAssignModal() {
        document.getElementById('assignModal').style.display = 'none';
        targetSlotIndex = null;
    }

    function assignPlayerToSlot(playerId) {
        if (targetSlotIndex === null) return;

        // 1. „Åæ„Åö„Åù„ÅÆ„Çπ„É≠„ÉÉ„Éà„ÇíÁ©∫„Å´„Åô„Çã
        const existing = appState.players.find(p => p.slotIndex === targetSlotIndex);
        if (existing) existing.slotIndex = null;

        // 2. ÈÅ∏Êâã„ÇíÈÖçÁΩÆÔºànull„Å™„ÇâÂ§ñ„Åô„Å†„ÅëÔºâ
        if (playerId) {
            const player = appState.players.find(p => p.id === playerId);
            if (player) player.slotIndex = targetSlotIndex;
        }

        renderApp();
        saveData();
        closeAssignModal();
    }


    // --- ÊèèÁîª ---
    function renderApp() {
        renderFormationSlots();
        renderPlayersOnField();
        renderPlayerList();
    }

    function renderPlayerList() {
        const list = document.getElementById('playerList');
        list.innerHTML = "";
        appState.players.forEach(p => {
            if (p.slotIndex === null) {
                const div = document.createElement('div');
                div.className = 'player-card';
                div.draggable = true;
                div.innerHTML = `
                    <div style="flex-grow:1; display:flex; align-items:center; gap:5px;">
                        <span style="font-weight:bold;">${p.name}</span>
                        <span class="player-pos-badge">${p.pos.join('/')}</span>
                    </div>
                    <button class="btn-edit" onclick="openEditModal('${p.id}')">‚úèÔ∏è</button>
                `;
                div.ondragstart = (e) => dragStart(e, p.id);
                div.ontouchstart = (e) => dragStart(e, p.id);
                list.appendChild(div);
            }
        });
        if(list.children.length === 0) list.innerHTML = "<div style='color:#bbb; text-align:center; padding:10px; font-size:0.8rem;'>„Éô„É≥„ÉÅ„ÅØÁ©∫„Åß„Åô</div>";
    }

    function renderFormationSlots() {
        const config = formations[appState.teamSize][appState.formationKey];
        const pitch = document.getElementById('pitch');
        document.getElementById('formationDesc').textContent = config.desc;
        document.getElementById('onImageFormationName').textContent = config.name;

        pitch.innerHTML = `
            <div class="penalty-area-top"></div><div class="goal-area-top"></div>
            <div class="penalty-area-bottom"></div><div class="goal-area-bottom"></div>
        `;

        config.slots.forEach((slot, index) => {
            const slotDiv = document.createElement('div');
            slotDiv.className = 'field-player';
            slotDiv.id = 'slot-' + index;
            slotDiv.style.left = slot.x + '%'; slotDiv.style.top = slot.y + '%';
            slotDiv.innerHTML = `<span style="opacity:0.3">${slot.r}</span>`;
            
            // „Éâ„É©„ÉÉ„Ç∞„Éâ„É≠„ÉÉ„ÉóÁî®
            slotDiv.ondragover = allowDrop;
            slotDiv.ondragleave = dragLeave;
            slotDiv.ondrop = (e) => dropToField(e, index);
            
            // ‚òÖ„Çø„ÉÉ„ÉóÈÖçÁΩÆÁî®Ôºà„Åì„Åì„ÅåÊñ∞Ê©üËÉΩÔºâ
            // „Éâ„É©„ÉÉ„Ç∞‰∏≠„Åß„Å™„ÅÑ„ÇØ„É™„ÉÉ„ÇØ„ÅÆ„ÅøÂèçÂøú„Åï„Åõ„Çã„Åü„ÇÅ„ÄÅonclick„Çí‰ΩøÁî®
            slotDiv.onclick = (e) => {
                // „Éâ„É©„ÉÉ„Ç∞ÁµÇ‰∫ÜÁõ¥Âæå„ÅÆ„ÇØ„É™„ÉÉ„ÇØÁô∫ÁÅ´„ÇíÈò≤„Åê„Å™„Å©„ÅÆÂà∂Âæ°„ÇÇËÄÉ„Åà„Çâ„Çå„Çã„Åå„ÄÅ
                // Âü∫Êú¨ÁöÑ„Å´„ÅØ„Åì„Çå„ÅßOK
                openAssignModal(index);
            };

            pitch.appendChild(slotDiv);
        });
    }

    function renderPlayersOnField() {
        appState.players.forEach(p => {
            if (p.slotIndex !== null) {
                const slotDiv = document.getElementById('slot-' + p.slotIndex);
                if (slotDiv) {
                    const mainPos = p.pos[0];
                    const bgColor = mainPos === 'GK' ? '#FFC107' : (mainPos === 'DF' ? '#2196F3' : (mainPos === 'MF' ? '#4CAF50' : '#E91E63'));
                    const textColor = mainPos === 'GK' ? '#000' : '#FFF';

                    slotDiv.style.background = bgColor; 
                    slotDiv.style.color = textColor;
                    slotDiv.style.border = "2px solid white";
                    slotDiv.innerHTML = `${p.nick}<div class="name-tooltip">${p.name}</div>`;
                    
                    slotDiv.draggable = true;
                    slotDiv.ondragstart = (evt) => dragStart(evt, p.id);
                    slotDiv.ontouchstart = (evt) => dragStart(evt, p.id);
                    
                    // Êó¢„Å´ÈÅ∏Êâã„Åå„ÅÑ„ÇãÂ†¥Âêà„ÇÇ„ÄÅ„ÇØ„É™„ÉÉ„ÇØ„Åß„É¢„Éº„ÉÄ„É´„ÇíÈñã„ÅèÔºàÂÖ•Êõø„ÉªËß£Èô§„ÅÆ„Åü„ÇÅÔºâ
                    slotDiv.onclick = (e) => {
                        e.stopPropagation(); // Ë¶™Ë¶ÅÁ¥†„Å∏„ÅÆ‰ºùÊí≠„ÇíÈò≤„Åê
                        openAssignModal(p.slotIndex);
                    };
                } else {
                    p.slotIndex = null;
                }
            }
        });
    }

    // --- „Éâ„É©„ÉÉ„Ç∞ÔºÜ„Éâ„É≠„ÉÉ„Éó ---
    function dragStart(e, playerId) {
        e.dataTransfer.effectAllowed = "move";
        e.dataTransfer.setData("text/plain", playerId);
    }
    function allowDrop(e) { e.preventDefault(); if(e.target.classList.contains('field-player')){ e.target.classList.add('drag-over'); } }
    function dragLeave(e) { if(e.target.classList.contains('field-player')){ e.target.classList.remove('drag-over'); } }
    function dropToField(e, slotIndex) {
        e.preventDefault(); e.stopPropagation(); // „ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà„Å®„ÅÆÂπ≤Ê∏âÈò≤Ê≠¢
        e.target.classList.remove('drag-over');
        const playerId = e.dataTransfer.getData("text/plain");
        const player = appState.players.find(p => p.id === playerId);
        if (!player) return;
        const existingPlayer = appState.players.find(p => p.slotIndex === slotIndex && p.id !== playerId);
        if (existingPlayer) existingPlayer.slotIndex = null;
        player.slotIndex = slotIndex;
        renderApp(); saveData();
    }
    function dropToBench(e) {
        e.preventDefault();
        const playerId = e.dataTransfer.getData("text/plain");
        const player = appState.players.find(p => p.id === playerId);
        if (player && player.slotIndex !== null) {
            player.slotIndex = null;
            renderApp(); saveData();
        }
    }

    // --- ÁîªÂÉè‰øùÂ≠ò ---
    function savePitchImage() {
        const captureArea = document.getElementById('captureArea');
        const btn = document.querySelector('.btn-save-img');
        const originalText = btn.textContent;
        btn.disabled = true; btn.textContent = "ÁîüÊàê‰∏≠...";
        html2canvas(captureArea, { scale: 2, backgroundColor: "#e0e0e0", logging: false, useCORS: true }).then(canvas => {
            const link = document.createElement('a');
            link.download = `formation_${new Date().getTime()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            btn.disabled = false; btn.textContent = originalText;
        }).catch(err => { console.error(err); alert("‰øùÂ≠ò„Ç®„É©„Éº"); btn.disabled = false; btn.textContent = originalText; });
    }
</script>
</body>
</html>
