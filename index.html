<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚µãƒƒã‚«ãƒ¼ãƒã‚¸ã‚·ãƒ§ãƒ³ãƒ—ãƒ­ãƒƒã‚¿ãƒ¼ Pro</title>
    <script src="https://Bernardo-Castilho.github.io/DragDropTouch/DragDropTouch.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --pitch-green: #4CAF50;
            --pitch-line: rgba(255, 255, 255, 0.8);
            --accent: #2196F3;
            --accent-dark: #1976D2;
            --danger: #FF5722;
        }
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            height: 100vh;
            box-sizing: border-box;
        }
        h1 { margin: 5px 0 15px 0; font-size: 1.2rem; text-align: center; }

        /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ (PCã¯æ¨ªä¸¦ã³ã€ã‚¹ãƒãƒ›ã¯ç¸¦ä¸¦ã³) */
        .container {
            display: flex;
            gap: 15px;
            flex-grow: 1;
            overflow: hidden; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åˆ¶å¾¡ */
        }
        @media (max-width: 768px) {
            .container { flex-direction: column-reverse; height: auto; overflow: visible; }
            body { height: auto; overflow-y: auto; }
            .sidebar { max-height: 400px; } /* ã‚¹ãƒãƒ›ã§ã®ãƒªã‚¹ãƒˆã®é«˜ã•åˆ¶é™ */
        }

        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
        .sidebar {
            flex: 1;
            min-width: 250px;
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        h3 { margin: 15px 0 10px 0; font-size: 1rem; color: #333; border-bottom: 2px solid #eee; padding-bottom: 5px;}
        .form-group { margin-bottom: 10px; }
        label { display: block; margin-bottom: 4px; font-weight: bold; font-size: 0.85rem; color: #555;}
        input, select {
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px;
        }
        button {
            width: 100%; padding: 12px; background-color: var(--accent); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: background 0.2s;
        }
        button:hover { background-color: var(--accent-dark); }
        .btn-danger { background-color: var(--danger); margin-top: 10px;}
        .btn-danger:hover { background-color: #E64A19; }
        .btn-save-img { background-color: var(--pitch-green); margin-bottom: 15px; }
        .btn-save-img:hover { background-color: #388E3C; }

        /* é¸æ‰‹ãƒªã‚¹ãƒˆ */
        .player-list {
            margin-top: 10px;
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 5px;
        }
        .player-card {
            background: #fff; border: 1px solid #eee; padding: 10px; margin-bottom: 8px; border-radius: 8px;
            cursor: grab; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            touch-action: none; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¹²æ¸‰é˜²æ­¢ */
        }
        .player-card:active { cursor: grabbing; }
        .player-pos-badge { background: #e0e0e0; font-size: 0.7rem; padding: 3px 6px; border-radius: 4px; font-weight: bold;}

        /* ãƒ”ãƒƒãƒã‚¨ãƒªã‚¢ */
        .pitch-area {
            flex: 2;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* ä¸Šå¯„ã›ã«å¤‰æ›´ */
            background: #e0e0e0; /* èƒŒæ™¯è‰²å¤‰æ›´ */
            border-radius: 12px;
            padding: 20px;
            overflow: auto;
            min-height: 300px;
            position: relative; /* ç”»åƒä¿å­˜æ™‚ã®ã‚­ãƒ£ãƒ—ãƒãƒ£ç¯„å›²ç”¨ */
        }

        .pitch {
            width: 100%;
            max-width: 500px; /* æœ€å¤§å¹…ã‚’å°‘ã—ç‹­ã */
            aspect-ratio: 2/3;
            background-color: var(--pitch-green);
            position: relative;
            border: 3px solid var(--pitch-line);
            box-sizing: border-box;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            /* èŠç”Ÿé¢¨ãƒ†ã‚¯ã‚¹ãƒãƒ£ï¼ˆç°¡æ˜“çš„ï¼‰ */
            background-image: repeating-linear-gradient(0deg, transparent, transparent 20px, rgba(0,0,0,0.05) 20px, rgba(0,0,0,0.05) 40px);
        }

        /* ãƒ”ãƒƒãƒã®ãƒ©ã‚¤ãƒ³æç”» */
        .pitch::before { content: ''; position: absolute; top: 50%; left: 0; right: 0; height: 2px; background: var(--pitch-line); margin-top:-1px;}
        .pitch::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 20%; height: 13.3%; border: 2px solid var(--pitch-line); border-radius: 50%;}
        .penalty-area-top { position: absolute; top: 0; left: 25%; width: 50%; height: 16%; border: 2px solid var(--pitch-line); border-top: none;}
        .penalty-area-bottom { position: absolute; bottom: 0; left: 25%; width: 50%; height: 16%; border: 2px solid var(--pitch-line); border-bottom: none;}
        .goal-area-top { position: absolute; top: 0; left: 37.5%; width: 25%; height: 6%; border: 2px solid var(--pitch-line); border-top: none; opacity: 0.7;}
        .goal-area-bottom { position: absolute; bottom: 0; left: 37.5%; width: 25%; height: 6%; border: 2px solid var(--pitch-line); border-bottom: none; opacity: 0.7;}


        /* é¸æ‰‹ãƒ‰ãƒƒãƒˆ */
        .field-player {
            position: absolute; transform: translate(-50%, -50%);
            width: 42px; height: 42px;
            background: rgba(255,255,255,0.9);
            border: 2px solid #333; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 0.7rem; font-weight: bold; color: #333;
            cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            text-align: center; z-index: 10;
            transition: all 0.2s ease;
            touch-action: none;
        }
        .field-player.drag-over { transform: translate(-50%, -50%) scale(1.1); background: rgba(255,255,255,0.5); }
        .field-player .name-tooltip {
            position: absolute; bottom: -22px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white; padding: 3px 8px;
            border-radius: 10px; white-space: nowrap; font-size: 0.75rem; pointer-events: none;
        }
        
        /* ç”»åƒä¿å­˜æ™‚ã®é€ã‹ã— */
        .watermark { position: absolute; bottom: 5px; right: 10px; font-size: 0.7rem; color: #666; opacity: 0.5; pointer-events: none; }
        /* ç¾åœ¨ã®ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º */
        .current-formation-display { position: absolute; top: 5px; left: 10px; font-weight: bold; color: #333; background: rgba(255,255,255,0.7); padding: 2px 5px; border-radius: 4px; pointer-events: none;}

    </style>
</head>
<body>

    <h1>ã‚µãƒƒã‚«ãƒ¼ãƒã‚¸ã‚·ãƒ§ãƒ³ãƒ—ãƒ­ãƒƒã‚¿ãƒ¼ Pro</h1>

    <div class="container">
        <div class="sidebar">
             <button class="btn-save-img" onclick="savePitchImage()">ğŸ“· é…ç½®ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>

            <h3>ãƒãƒ¼ãƒ è¨­å®š</h3>
            <div class="form-group">
                <label>äººæ•°åˆ¶</label>
                <select id="teamSizeSelector" onchange="handleSizeChange()">
                    <option value="8">8äººåˆ¶ (ã‚¸ãƒ¥ãƒ‹ã‚¢ãƒ»ã‚½ã‚µã‚¤ãƒ)</option>
                    <option value="11" selected>11äººåˆ¶ (ãƒ•ãƒ«ã‚³ãƒ¼ãƒˆ)</option>
                </select>
            </div>
            <div class="form-group">
                <label>ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³</label>
                <select id="formationSelector" onchange="handleFormationChange()">
                    </select>
                <small id="formationDesc" style="color: #666; font-size: 0.8rem; display:block; margin-top:5px;"></small>
            </div>

            <h3>æ–°è¦é¸æ‰‹ç™»éŒ²</h3>
            <div style="display: flex; gap: 5px; margin-bottom: 5px;">
                <input type="text" id="playerName" placeholder="åå‰ (ä¾‹:å±±ç”°å¤ªéƒ)" style="flex:2">
                <input type="text" id="playerNick" placeholder="çŸ­ç¸®å (ä¾‹:å±±)" style="flex:1">
            </div>
            <div class="form-group">
                 <select id="playerPosition">
                    <option value="FW">FW (ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰)</option>
                    <option value="MF" selected>MF (ãƒŸãƒƒãƒ‰ãƒ•ã‚£ãƒ«ãƒ€ãƒ¼)</option>
                    <option value="DF">DF (ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ãƒ€ãƒ¼)</option>
                    <option value="GK">GK (ã‚´ãƒ¼ãƒ«ã‚­ãƒ¼ãƒ‘ãƒ¼)</option>
                </select>
            </div>
            <button onclick="addPlayer()">é¸æ‰‹ã‚’è¿½åŠ </button>

            <h3>ãƒ™ãƒ³ãƒ / å¾…æ©Ÿé¸æ‰‹ <small>(ãƒ‰ãƒ©ãƒƒã‚°ã§é…ç½®)</small></h3>
            <div id="playerList" class="player-list" ondragover="allowDrop(event)" ondrop="dropToBench(event)" style="min-height: 100px; border: 2px dashed #ddd; border-radius: 8px; padding: 5px;">
                </div>
             <button class="btn-danger" onclick="clearAllData()">å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
        </div>

        <div class="pitch-area" id="captureArea">
            <div class="current-formation-display" id="onImageFormationName"></div>
            <div class="pitch" id="pitch">
                <div class="penalty-area-top"></div><div class="goal-area-top"></div>
                <div class="penalty-area-bottom"></div><div class="goal-area-bottom"></div>
                </div>
            <div class="watermark">Created with Position Plotter Pro</div>
        </div>
    </div>

<script>
    // --- ãƒ‡ãƒ¼ã‚¿å®šç¾© (ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åº§æ¨™ Top=0%, Left=0%) ---
    // æ”»æ’ƒæ–¹å‘ã¯ä¸Šå‘ãï¼ˆTopãŒç›¸æ‰‹ã‚´ãƒ¼ãƒ«ã€BottomãŒè‡ªé™£ã‚´ãƒ¼ãƒ«ï¼‰
    const formations = {
        "8": {
            "2-3-2": { name: "2-3-2 (JFAæ¨å¥¨)", desc: "ãƒãƒ©ãƒ³ã‚¹å‹ã€‚å€‹ã®èƒ½åŠ›å‘ä¸Šã«é©ã—ãŸå½¢ã€‚", slots: [{x:50,y:90,r:"GK"},{x:30,y:75,r:"DF"},{x:70,y:75,r:"DF"},{x:20,y:50,r:"MF"},{x:50,y:50,r:"MF"},{x:80,y:50,r:"MF"},{x:35,y:25,r:"FW"},{x:65,y:25,r:"FW"}]},
            "3-3-1": { name: "3-3-1", desc: "æœ€ã‚‚ä¸€èˆ¬çš„ãƒ»å®‰å®šå‹ã€‚", slots: [{x:50,y:90,r:"GK"},{x:20,y:75,r:"DF"},{x:50,y:75,r:"DF"},{x:80,y:75,r:"DF"},{x:25,y:50,r:"MF"},{x:50,y:45,r:"MF"},{x:75,y:50,r:"MF"},{x:50,y:20,r:"FW"}]},
            "2-4-1": { name: "2-4-1", desc: "ä¸­ç›¤æ”¯é…å‹ã€‚", slots: [{x:50,y:90,r:"GK"},{x:35,y:80,r:"DF"},{x:65,y:80,r:"DF"},{x:15,y:50,r:"MF"},{x:40,y:55,r:"MF"},{x:60,y:55,r:"MF"},{x:85,y:50,r:"MF"},{x:50,y:20,r:"FW"}]},
            "3-2-2": { name: "3-2-2", desc: "å®ˆå‚™ãƒ»ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼å‹ã€‚", slots: [{x:50,y:90,r:"GK"},{x:20,y:75,r:"DF"},{x:50,y:80,r:"DF"},{x:80,y:75,r:"DF"},{x:35,y:50,r:"MF"},{x:65,y:50,r:"MF"},{x:35,y:20,r:"FW"},{x:65,y:20,r:"FW"}]}
        },
        "11": {
            "4-4-2": { name: "4-4-2", desc: "ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸä¼çµ±å½¢ã€‚", slots: [{x:50,y:92,r:"GK"},{x:15,y:78,r:"SB"},{x:38,y:82,r:"CB"},{x:62,y:82,r:"CB"},{x:85,y:78,r:"SB"},{x:15,y:45,r:"SH"},{x:38,y:52,r:"CH"},{x:62,y:52,r:"CH"},{x:85,y:45,r:"SH"},{x:35,y:20,r:"FW"},{x:65,y:20,r:"FW"}]},
            "4-3-3": { name: "4-3-3", desc: "ã‚µã‚¤ãƒ‰æ”»æ’ƒå‹ã€‚ã‚¢ãƒ³ã‚«ãƒ¼1æšã€‚", slots: [{x:50,y:92,r:"GK"},{x:15,y:78,r:"SB"},{x:38,y:82,r:"CB"},{x:62,y:82,r:"CB"},{x:85,y:78,r:"SB"},{x:50,y:65,r:"DMF"},{x:30,y:45,r:"OMF"},{x:70,y:45,r:"OMF"},{x:15,y:25,r:"WG"},{x:50,y:18,r:"CF"},{x:85,y:25,r:"WG"}]},
            "4-2-3-1": { name: "4-2-3-1", desc: "ãƒ€ãƒ–ãƒ«ãƒœãƒ©ãƒ³ãƒã€‚æ”»æ’ƒã®èµ·ç‚¹ã‚’ä½œã‚‹ã€‚", slots: [{x:50,y:92,r:"GK"},{x:12,y:78,r:"SB"},{x:36,y:82,r:"CB"},{x:64,y:82,r:"CB"},{x:88,y:78,r:"SB"},{x:38,y:62,r:"DMF"},{x:62,y:62,r:"DMF"},{x:15,y:38,r:"SH"},{x:50,y:38,r:"OH"},{x:85,y:38,r:"SH"},{x:50,y:18,r:"CF"}]},
            "3-5-2": { name: "3-5-2", desc: "ä¸­ç›¤æ”¯é…ã€‚ã‚µã‚¤ãƒ‰ã‚’åºƒãä½¿ã†ã€‚", slots: [{x:50,y:92,r:"GK"},{x:20,y:80,r:"CB"},{x:50,y:84,r:"CB"},{x:80,y:80,r:"CB"},{x:8,y:50,r:"WB"},{x:35,y:58,r:"DMF"},{x:65,y:58,r:"DMF"},{x:92,y:50,r:"WB"},{x:50,y:40,r:"OMF"},{x:35,y:20,r:"FW"},{x:65,y:20,r:"FW"}]},
            "3-4-3": { name: "3-4-3", desc: "æ”»æ’ƒçš„3ãƒãƒƒã‚¯ã€‚", slots: [{x:50,y:92,r:"GK"},{x:20,y:80,r:"CB"},{x:50,y:84,r:"CB"},{x:80,y:80,r:"CB"},{x:12,y:50,r:"WB"},{x:40,y:58,r:"CH"},{x:60,y:58,r:"CH"},{x:88,y:50,r:"WB"},{x:20,y:22,r:"WG"},{x:50,y:18,r:"CF"},{x:80,y:22,r:"WG"}]}
        }
    };

    // ã‚¢ãƒ—ãƒªã®çŠ¶æ…‹å¤‰æ•°
    let appState = {
        players: [],
        teamSize: "11",
        formationKey: "4-4-2"
    };
    const STORAGE_KEY = 'soccerPlotterData_v2';

    // --- åˆæœŸåŒ– ---
    window.onload = function() {
        loadData(); // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        updateFormationOptions(false); // ã‚ªãƒ—ã‚·ãƒ§ãƒ³æ›´æ–°ï¼ˆæç”»ã¯loadDataãŒã‚„ã‚‹ã®ã§falseï¼‰
        renderApp(); // ç”»é¢å…¨ä½“ã®æç”»
    };

    // --- ãƒ‡ãƒ¼ã‚¿ç®¡ç† (Local Storage) ---
    function saveData() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
    }

    function loadData() {
        const data = localStorage.getItem(STORAGE_KEY);
        if (data) {
            try {
                appState = JSON.parse(data);
                // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’å¾©å…ƒ
                document.getElementById('teamSizeSelector').value = appState.teamSize;
            } catch (e) { console.error("ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼", e); localStorage.removeItem(STORAGE_KEY); }
        }
    }

    function clearAllData() {
        if(confirm("æœ¬å½“ã«å…¨ã¦ã®é¸æ‰‹ãƒ‡ãƒ¼ã‚¿ã¨è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")){
            localStorage.removeItem(STORAGE_KEY);
            location.reload();
        }
    }

    // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ© ---
    function handleSizeChange() {
        appState.teamSize = document.getElementById('teamSizeSelector').value;
        updateFormationOptions(true);
    }

    function handleFormationChange() {
        appState.formationKey = document.getElementById('formationSelector').value;
        renderApp(); // ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¤‰æ›´æ™‚ã¯å†æç”»
        saveData();
    }

    // ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é¸æŠè‚¢ã®æ›´æ–°
    function updateFormationOptions(shouldRender) {
        const size = appState.teamSize;
        const selector = document.getElementById('formationSelector');
        selector.innerHTML = "";

        const options = formations[size];
        let firstKey = null;
        for (const key in options) {
            if(!firstKey) firstKey = key;
            const opt = document.createElement('option');
            opt.value = key;
            opt.textContent = options[key].name;
            if(key === appState.formationKey) opt.selected = true;
            selector.appendChild(opt);
        }
        // ç¾åœ¨ã®é¸æŠãŒæ–°ã‚µã‚¤ã‚ºã«å­˜åœ¨ã—ãªã„å ´åˆã€å…ˆé ­ã‚’é¸æŠ
        if(!options[appState.formationKey]){
            appState.formationKey = firstKey;
             if(selector.options.length > 0) selector.options[0].selected = true;
        }

        if(shouldRender) {
             renderApp();
             saveData();
        }
    }

    // é¸æ‰‹è¿½åŠ 
    function addPlayer() {
        const nameInput = document.getElementById('playerName');
        const nickInput = document.getElementById('playerNick');
        const posInput = document.getElementById('playerPosition');

        if (!nameInput.value) { alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

        const player = {
            id: Date.now().toString(), // ãƒ¦ãƒ‹ãƒ¼ã‚¯ID
            name: nameInput.value,
            nick: nickInput.value || nameInput.value.slice(0, 2),
            pos: posInput.value,
            slotIndex: null // ã©ã®ã‚¹ãƒ­ãƒƒãƒˆã«ã„ã‚‹ã‹ (nullãªã‚‰ãƒ™ãƒ³ãƒ)
        };

        appState.players.push(player);
        renderPlayerList();
        saveData();
        
        nameInput.value = ""; nickInput.value = "";
    }

    // --- æç”»é–¢é€£ ---
    function renderApp() {
        renderFormationSlots();
        renderPlayersOnField();
        renderPlayerList();
    }

    // ãƒ™ãƒ³ãƒãƒªã‚¹ãƒˆæç”»
    function renderPlayerList() {
        const list = document.getElementById('playerList');
        list.innerHTML = "";
        appState.players.forEach(p => {
            if (p.slotIndex === null) { // ãƒ™ãƒ³ãƒã«ã„ã‚‹é¸æ‰‹
                const div = document.createElement('div');
                div.className = 'player-card';
                div.draggable = true;
                div.innerHTML = `<span>${p.name}</span><span class="player-pos-badge">${p.pos}</span>`;
                div.ondragstart = (e) => dragStart(e, p.id);
                // ã‚¹ãƒãƒ›ç”¨ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆ(PolyfillãŒå‡¦ç†ã™ã‚‹ãŒæ˜ç¤ºçš„ã«ã‚‚ä»˜ä¸)
                div.ontouchstart = (e) => dragStart(e, p.id);
                list.appendChild(div);
            }
        });
        if(list.children.length === 0) list.innerHTML = "<div style='color:#999; text-align:center; padding:10px;'>ç©ºå¸­</div>";
    }

    // ãƒ”ãƒƒãƒä¸Šã®ã‚¹ãƒ­ãƒƒãƒˆ(æ )æç”»
    function renderFormationSlots() {
        const config = formations[appState.teamSize][appState.formationKey];
        const pitch = document.getElementById('pitch');
        
        document.getElementById('formationDesc').textContent = config.desc;
        document.getElementById('onImageFormationName').textContent = config.name;

        // ãƒ”ãƒƒãƒå†…ã®æ—¢å­˜ã‚¹ãƒ­ãƒƒãƒˆã‚’ã‚¯ãƒªã‚¢ï¼ˆãƒ©ã‚¤ãƒ³ä»¥å¤–ï¼‰
        pitch.innerHTML = `
            <div class="penalty-area-top"></div><div class="goal-area-top"></div>
            <div class="penalty-area-bottom"></div><div class="goal-area-bottom"></div>
        `;

        config.slots.forEach((slot, index) => {
            const slotDiv = document.createElement('div');
            slotDiv.className = 'field-player';
            slotDiv.id = 'slot-' + index;
            slotDiv.style.left = slot.x + '%'; slotDiv.style.top = slot.y + '%';
            slotDiv.innerHTML = `<span style="opacity:0.3">${slot.r}</span>`;
            // ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³è¨­å®š
            slotDiv.ondragover = allowDrop;
            slotDiv.ondragleave = dragLeave;
            slotDiv.ondrop = (e) => dropToField(e, index);
            pitch.appendChild(slotDiv);
        });
    }

    // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä¸Šã®é¸æ‰‹æç”»
    function renderPlayersOnField() {
        appState.players.forEach(p => {
            if (p.slotIndex !== null) {
                const slotDiv = document.getElementById('slot-' + p.slotIndex);
                if (slotDiv) {
                    updateSlotAppearance(slotDiv, p);
                } else {
                    // ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¤‰æ›´ã§ã‚¹ãƒ­ãƒƒãƒˆãŒãªããªã£ãŸå ´åˆã€ãƒ™ãƒ³ãƒã«æˆ»ã™
                    p.slotIndex = null;
                }
            }
        });
        // ã‚¹ãƒ­ãƒƒãƒˆã‹ã‚‰æº¢ã‚ŒãŸé¸æ‰‹ãŒã„ãŸå ´åˆã®ãŸã‚ã«å†ä¿å­˜
        saveData();
    }

    function updateSlotAppearance(slotDiv, player) {
        const bgColor = player.pos === 'GK' ? '#FFC107' : (player.pos === 'DF' ? '#2196F3' : (player.pos === 'MF' ? '#4CAF50' : '#E91E63'));
        const textColor = '#FFF';

        slotDiv.style.background = bgColor; slotDiv.style.color = textColor;
        slotDiv.style.border = "2px solid white";
        slotDiv.innerHTML = `${player.nick}<div class="name-tooltip">${player.name}</div>`;
        slotDiv.draggable = true;
        slotDiv.ondragstart = (evt) => dragStart(evt, player.id);
        slotDiv.ontouchstart = (evt) => dragStart(evt, player.id);
    }

    // --- ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç† (ã‚¹ãƒãƒ›ã¯PolyfillãŒã“ã‚Œã‚’ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ) ---
    function dragStart(e, playerId) {
        e.dataTransfer.effectAllowed = "move";
        e.dataTransfer.setData("text/plain", playerId);
    }
    function allowDrop(e) {
        e.preventDefault();
        if(e.target.classList.contains('field-player')){
             e.target.classList.add('drag-over');
        }
    }
    function dragLeave(e) {
         if(e.target.classList.contains('field-player')){
             e.target.classList.remove('drag-over');
        }
    }

    // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¸ã®ãƒ‰ãƒ­ãƒƒãƒ—
    function dropToField(e, slotIndex) {
        e.preventDefault();
        e.target.classList.remove('drag-over');
        const playerId = e.dataTransfer.getData("text/plain");
        const player = appState.players.find(p => p.id === playerId);
        if (!player) return;

        // 1. ç§»å‹•å…ƒã®å‡¦ç†: å…ƒã€…ã“ã®é¸æ‰‹ãŒã„ãŸå ´æ‰€ã‚’ç©ºã‘ã‚‹
        // (slotIndexãŒnullãªã‚‰ãƒ™ãƒ³ãƒãªã®ã§ä½•ã‚‚ã—ãªãã¦è‰¯ã„)

        // 2. ç§»å‹•å…ˆã®å‡¦ç†: ãƒ‰ãƒ­ãƒƒãƒ—ã—ãŸã‚¹ãƒ­ãƒƒãƒˆã«æ—¢ã«ä»–ã®é¸æ‰‹ãŒã„ãŸã‚‰ã€ãã®é¸æ‰‹ã‚’ã€Œè¿½ã„å‡ºã™ã€
        // (è¿½ã„å‡ºã•ã‚ŒãŸé¸æ‰‹ã¯ã€ç§»å‹•å…ƒã®å ´æ‰€ã«è¡Œãã‹ã€ãƒ™ãƒ³ãƒã«è¡Œãã‹ã€‚ä»Šå›ã¯ãƒ™ãƒ³ãƒã«æˆ»ã™ä»•æ§˜ã¨ã™ã‚‹)
        const existingPlayer = appState.players.find(p => p.slotIndex === slotIndex && p.id !== playerId);
        if (existingPlayer) {
            existingPlayer.slotIndex = null; // ãƒ™ãƒ³ãƒã¸
        }

        // 3. é…ç½®ã‚’ç¢ºå®š
        player.slotIndex = slotIndex;
        
        renderApp(); // å…¨ä½“å†æç”»
        saveData();
    }

    // ãƒ™ãƒ³ãƒã‚¨ãƒªã‚¢ã¸ã®ãƒ‰ãƒ­ãƒƒãƒ—
    function dropToBench(e) {
        e.preventDefault();
        const playerId = e.dataTransfer.getData("text/plain");
        const player = appState.players.find(p => p.id === playerId);
        
        // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã‚‰ãƒ™ãƒ³ãƒã¸ã®ç§»å‹•ã®ã¿å‡¦ç†
        if (player && player.slotIndex !== null) {
            player.slotIndex = null;
            renderApp();
            saveData();
        }
    }

    // --- ç”»åƒä¿å­˜æ©Ÿèƒ½ ---
    function savePitchImage() {
        const captureArea = document.getElementById('captureArea');
        const btn = document.querySelector('.btn-save-img');
        btn.disabled = true; btn.textContent = "ç”Ÿæˆä¸­...";

        // html2canvasã‚’ä½¿ã£ã¦å¯¾è±¡ã‚¨ãƒªã‚¢ã‚’ç”»åƒåŒ–
        html2canvas(captureArea, {
            scale: 2, // é«˜è§£åƒåº¦ã§å–å¾—
            backgroundColor: "#e0e0e0", // èƒŒæ™¯è‰²ã‚’æŒ‡å®š
            logging: false
        }).then(canvas => {
            // ç”»åƒãƒªãƒ³ã‚¯ã‚’ä½œæˆã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç™ºç«
            const link = document.createElement('a');
            link.download = `formation_${appState.formationKey}_${new Date().getTime()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            btn.disabled = false; btn.textContent = "ğŸ“· é…ç½®ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰";
        }).catch(err => {
            alert("ç”»åƒã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ");
            console.error(err);
            btn.disabled = false; btn.textContent = "ğŸ“· é…ç½®ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰";
        });
    }

</script>
</body>
</html>